CREATE TABLE CATEGORIA
( 
	IDCATEGORIA          integer  NOT NULL ,
	NOMBRE               varchar(50)  NOT NULL ,
	CONSTRAINT XPKCATEGORIA PRIMARY KEY (IDCATEGORIA ASC)
)
go

INSERT INTO CATEGORIA(IDCATEGORIA,NOMBRE) VALUES(1,'LINEA BLANCA');
INSERT INTO CATEGORIA(IDCATEGORIA,NOMBRE) VALUES(2,'MENAJE');
INSERT INTO CATEGORIA(IDCATEGORIA,NOMBRE) VALUES(3,'MUEBLES');
INSERT INTO CATEGORIA(IDCATEGORIA,NOMBRE) VALUES(4,'ROPA MUJER');
INSERT INTO CATEGORIA(IDCATEGORIA,NOMBRE) VALUES(5,'ROPA HOMBRE');
GO


CREATE TABLE TIPODOC
( 
	IDTIPODOC            integer  NOT NULL ,
	NOMBRE               varchar(50)  NOT NULL ,
	CONSTRAINT XPKTIPODOC PRIMARY KEY (IDTIPODOC ASC)
)
go


INSERT INTO TIPODOC(IDTIPODOC,NOMBRE) VALUES(1,'RUC');
INSERT INTO TIPODOC(IDTIPODOC,NOMBRE) VALUES(2,'DNI');


CREATE TABLE CLIENTE
( 
	IDCLIENTE            integer IDENTITY ( 1,1 ) NOT NULL ,
	NOMBRE               varchar(150)  NOT NULL ,
	IDTIPODOC            integer  NOT NULL ,
	NRODOC               varchar(20)  NOT NULL ,
	DIRRECCION           varchar(200)  NOT NULL ,
	CELULAR              varchar(20)  NULL ,
	CORREO               varchar(50)  NULL ,
	CONSTRAINT XPKCLIENTE PRIMARY KEY (IDCLIENTE ASC),
	CONSTRAINT FK_CLIENTE_TIPODOC FOREIGN KEY (IDTIPODOC) REFERENCES TIPODOC(IDTIPODOC)
		ON DELETE NO ACTION
		ON UPDATE NO ACTION
)
go

SET IDENTITY_INSERT CLIENTE ON
GO

INSERT INTO CLIENTE(IDCLIENTE,NOMBRE,IDTIPODOC,NRODOC,DIRRECCION) VALUES(1,'AGRICOLA LA CHACRA S.R.L.',1,20396033731,'Av. Las Palmeras 333 - San Isidro');
INSERT INTO CLIENTE(IDCLIENTE,NOMBRE,IDTIPODOC,NRODOC,DIRRECCION) VALUES(2,'Delfus Delfin',2,87354974,'Jr. Ucayali 222 - Lima');
GO

SET IDENTITY_INSERT CLIENTE OFF
GO

CREATE TABLE ROL
( 
	IDROL                integer  NOT NULL ,
	NOMBRE               varchar(100)  NOT NULL ,
	CONSTRAINT XPKROL PRIMARY KEY (IDROL ASC)
)
go


INSERT INTO ROL(IDROL,NOMBRE) VALUES(1,'Vendedor');
INSERT INTO ROL(IDROL,NOMBRE) VALUES(2,'Administrador');
GO


CREATE TABLE EMPLEADO
( 
	IDEMPLEADO           integer IDENTITY ( 1,1 ) NOT NULL ,
	NOMBRE               varchar(100)  NOT NULL ,
	APELLIDO             varchar(100)  NOT NULL ,
	IDROL                integer  NULL ,
	DIRECCION            varchar(150)  NOT NULL ,
	CELULAR              varchar(20)  NULL ,
	CORREO               varchar(100)  NOT NULL ,
	CONSTRAINT XPKEMPLEADO PRIMARY KEY (IDEMPLEADO ASC),
	CONSTRAINT FK_EM_LEADO_ROL FOREIGN KEY (IDROL) REFERENCES ROL(IDROL)
		ON DELETE NO ACTION
		ON UPDATE NO ACTION
)
go

SET IDENTITY_INSERT EMPLEADO ON
GO

INSERT INTO EMPLEADO(IDEMPLEADO,NOMBRE,APELLIDO,IDROL,DIRECCION,CORREO) VALUES(1,'Elfa','Ramirez',1,'Av. Villaran 657 - Surquillo','elfaramirez@taas.pe');
INSERT INTO EMPLEADO(IDEMPLEADO,NOMBRE,APELLIDO,IDROL,DIRECCION,CORREO) VALUES(2,'Angel','Bubu',2,'Av. Tupac Amaru 100 - SMP','angelbubu@taas.pe');
GO

SET IDENTITY_INSERT EMPLEADO OFF
GO

CREATE TABLE USUARIO
( 
	IDEMPLEADO           integer  NOT NULL ,
	USUARIO              varchar(20)  NOT NULL ,
	CLAVE                varchar(20)  NOT NULL ,
	ESTADO               integer  NOT NULL ,
	CONSTRAINT XPKUSUARIO PRIMARY KEY (IDEMPLEADO ASC),
	CONSTRAINT XAK1USUARIO UNIQUE (USUARIO  ASC),
	CONSTRAINT FK_USUARIO_EMPLEADO FOREIGN KEY (IDEMPLEADO) REFERENCES EMPLEADO(IDEMPLEADO)
		ON DELETE NO ACTION
		ON UPDATE NO ACTION
)
go


INSERT INTO USUARIO(IDEMPLEADO,USUARIO,CLAVE,ESTADO) VALUES(1,'eramirez','secreto',1);
INSERT INTO USUARIO(IDEMPLEADO,USUARIO,CLAVE,ESTADO) VALUES(2,'abubu','secreto',2);
GO


CREATE TABLE TIPOVENTA
( 
	IDTIPOVENTA          integer  NOT NULL ,
	NOMBRE               varchar(50)  NOT NULL ,
	CONSTRAINT XPKTIPOVENTA PRIMARY KEY (IDTIPOVENTA ASC)
)
go

INSERT INTO TIPOVENTA(IDTIPOVENTA,NOMBRE) VALUES(1,'En Tienda');
INSERT INTO TIPOVENTA(IDTIPOVENTA,NOMBRE) VALUES(2,'Delivery');
go



CREATE TABLE ESTADO
( 
	IDESTADO             integer  NOT NULL ,
	DESCRIPCION          varchar(100)  NOT NULL ,
	CONSTRAINT XPKESTADO PRIMARY KEY (IDESTADO ASC)
)
go


INSERT INTO ESTADO(IDESTADO,DESCRIPCION) VALUES(1,'En proceso');
INSERT INTO ESTADO(IDESTADO,DESCRIPCION) VALUES(2,'Finalizado');
INSERT INTO ESTADO(IDESTADO,DESCRIPCION) VALUES(3,'Cancelado');
go


CREATE TABLE TIPOCOMP
( 
	IDTIPOCOMP           integer  NOT NULL ,
	NOMBRE               varchar(50)  NOT NULL ,
	PREFIJO              varchar(10)  NOT NULL ,
	CONTADOR             integer  NOT NULL ,
	CONSTRAINT XPKTIPOCOMP PRIMARY KEY (IDTIPOCOMP ASC)
)
go


INSERT INTO TIPOCOMP(IDTIPOCOMP,NOMBRE,PREFIJO,CONTADOR) VALUES(1,'Factura','FAC-',6);
INSERT INTO TIPOCOMP(IDTIPOCOMP,NOMBRE,PREFIJO,CONTADOR) VALUES(2,'Boleta','BOL-',5);
go 



CREATE TABLE PEDIDO
( 
	IDPEDIDO             integer IDENTITY ( 1,1 ) NOT NULL,
	FECHA                datetime  NOT NULL ,
	IDEMPLEADO           integer  NOT NULL ,
	IDCLIENTE            integer  NOT NULL ,
	IDTIPOVENTA          integer  NOT NULL ,
	IDESTADO             integer  NOT NULL ,
	IDTIPOCOMP           integer  NOT NULL ,
	NROCOMP              varchar(20)  NOT NULL ,
	IMPORTE              numeric(10,2)  NOT NULL ,
	IMPUESTO             numeric(10,2)  NOT NULL ,
	TOTAL                numeric(10,2)  NOT NULL ,
	CONSTRAINT XPKPEDIDO PRIMARY KEY (IDPEDIDO ASC),
	CONSTRAINT FK_PEDIDO_CLIENTE FOREIGN KEY (IDCLIENTE) REFERENCES CLIENTE(IDCLIENTE)
		ON DELETE NO ACTION
		ON UPDATE NO ACTION,
CONSTRAINT FK_PEDIDO_USUARIO FOREIGN KEY (IDEMPLEADO) REFERENCES USUARIO(IDEMPLEADO)
		ON DELETE NO ACTION
		ON UPDATE NO ACTION,
CONSTRAINT FK_PEDIDO_TIPOVENTA FOREIGN KEY (IDTIPOVENTA) REFERENCES TIPOVENTA(IDTIPOVENTA)
		ON DELETE NO ACTION
		ON UPDATE NO ACTION,
CONSTRAINT FK_PEDIDO_ESTADO FOREIGN KEY (IDESTADO) REFERENCES ESTADO(IDESTADO)
		ON DELETE NO ACTION
		ON UPDATE NO ACTION,
CONSTRAINT FK_PEDIDO_TIPOCOMP FOREIGN KEY (IDTIPOCOMP) REFERENCES TIPOCOMP(IDTIPOCOMP)
		ON DELETE NO ACTION
		ON UPDATE NO ACTION
)
go



SET IDENTITY_INSERT PEDIDO ON
go

INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,IDEMPLEADO,IDTIPOVENTA,IDESTADO,IDTIPOCOMP,NROCOMP,IMPORTE,IMPUESTO,TOTAL) VALUES(1,29/01/2020,1,1,1,2,2,'BOL-0001',50,10,60);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,IDEMPLEADO,IDTIPOVENTA,IDESTADO,IDTIPOCOMP,NROCOMP,IMPORTE,IMPUESTO,TOTAL) VALUES(2,29/01/2020,1,1,1,2,2,'BOL-0002',100,10,110);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,IDEMPLEADO,IDTIPOVENTA,IDESTADO,IDTIPOCOMP,NROCOMP,IMPORTE,IMPUESTO,TOTAL) VALUES(3,29/01/2020,1,1,1,2,2,'BOL-0003',150,10,160);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,IDEMPLEADO,IDTIPOVENTA,IDESTADO,IDTIPOCOMP,NROCOMP,IMPORTE,IMPUESTO,TOTAL) VALUES(4,29/01/2020,1,1,1,2,2,'BOL-0004',200,10,210);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,IDEMPLEADO,IDTIPOVENTA,IDESTADO,IDTIPOCOMP,NROCOMP,IMPORTE,IMPUESTO,TOTAL) VALUES(5,29/01/2020,1,1,1,2,2,'BOL-0005',250,10,260);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,IDEMPLEADO,IDTIPOVENTA,IDESTADO,IDTIPOCOMP,NROCOMP,IMPORTE,IMPUESTO,TOTAL) VALUES(6,29/01/2020,2,1,2,1,1,'FAC-0001',300,10,310);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,IDEMPLEADO,IDTIPOVENTA,IDESTADO,IDTIPOCOMP,NROCOMP,IMPORTE,IMPUESTO,TOTAL) VALUES(7,29/01/2020,2,1,2,2,1,'FAC-0002',350,10,360);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,IDEMPLEADO,IDTIPOVENTA,IDESTADO,IDTIPOCOMP,NROCOMP,IMPORTE,IMPUESTO,TOTAL) VALUES(8,29/01/2020,2,1,2,3,1,'FAC-0003',400,10,410);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,IDEMPLEADO,IDTIPOVENTA,IDESTADO,IDTIPOCOMP,NROCOMP,IMPORTE,IMPUESTO,TOTAL) VALUES(9,29/01/2020,2,1,2,1,1,'FAC-0004',450,10,460);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,IDEMPLEADO,IDTIPOVENTA,IDESTADO,IDTIPOCOMP,NROCOMP,IMPORTE,IMPUESTO,TOTAL) VALUES(10,29/01/2020,2,1,2,2,1,'FAC-0005',500,10,510);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,IDEMPLEADO,IDTIPOVENTA,IDESTADO,IDTIPOCOMP,NROCOMP,IMPORTE,IMPUESTO,TOTAL) VALUES(11,29/01/2020,2,1,2,2,1,'FAC-0006',600,10,610);
go

SET IDENTITY_INSERT PEDIDO OFF
go



CREATE TABLE PRODUCTO
( 
	IDPRODUCTO           integer IDENTITY ( 1,1 ) ,
	IDCATEGORIA          integer  NOT NULL ,
	NOMBRE               varchar(100)  NOT NULL ,
	PRECOSTO             numeric(10,2)  NOT NULL ,
	PREVENTA             numeric(10,2)  NOT NULL ,
	CONSTRAINT XPKPRODUCTO PRIMARY KEY (IDPRODUCTO ASC),
	CONSTRAINT FK_PRODUCTO_CATEGORIA FOREIGN KEY (IDCATEGORIA) REFERENCES CATEGORIA(IDCATEGORIA)
		ON DELETE NO ACTION
		ON UPDATE NO ACTION
)
go


SET IDENTITY_INSERT PRODUCTO ON
go

INSERT INTO PRODUCTO(IDPRODUCTO,IDCATEGORIA,NOMBRE,PRECOSTO,PREVENTA) VALUES(1,1,'Blusa UNIVERSITY',25,50);
INSERT INTO PRODUCTO(IDPRODUCTO,IDCATEGORIA,NOMBRE,PRECOSTO,PREVENTA) VALUES(2,2,'Pantalón Jean JHONSON',35,45);
INSERT INTO PRODUCTO(IDPRODUCTO,IDCATEGORIA,NOMBRE,PRECOSTO,PREVENTA) VALUES(3,1,'Set de platos decorativos EL PLATITO',50,120);
go

SET IDENTITY_INSERT PRODUCTO OFF
go



CREATE TABLE DETALLE
( 
	IDDETALLE            integer IDENTITY ( 1,1 ) ,
	IDPEDIDO             integer  NOT NULL ,
	IDPRODUCTO           integer  NOT NULL ,
	CANTIDAD             integer  NOT NULL ,
	PRECIOVENTA          numeric(10,2)  NOT NULL ,
	SUBTOTAL             numeric(10,2)  NOT NULL ,
	CONSTRAINT XPKDETALLE PRIMARY KEY (IDDETALLE ASC),
	CONSTRAINT FK_DETALLE_PEDIDO FOREIGN KEY (IDPEDIDO) REFERENCES PEDIDO(IDPEDIDO)
		ON DELETE NO ACTION
		ON UPDATE NO ACTION,
CONSTRAINT FK_DETALLE_PRODUCTO FOREIGN KEY (IDPRODUCTO) REFERENCES PRODUCTO(IDPRODUCTO)
		ON DELETE NO ACTION
		ON UPDATE NO ACTION
)
go




SET IDENTITY_INSERT DETALLE ON
go

INSERT INTO DETALLE(IDDETALLE,IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIOVENTA,SUBTOTAL) VALUES(1,1,1,2,50,100);
INSERT INTO DETALLE(IDDETALLE,IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIOVENTA,SUBTOTAL) VALUES(2,1,2,2,100,200);

INSERT INTO DETALLE(IDDETALLE,IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIOVENTA,SUBTOTAL) VALUES(3,2,2,1,45,45);
INSERT INTO DETALLE(IDDETALLE,IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIOVENTA,SUBTOTAL) VALUES(4,2,3,3,50,150);

INSERT INTO DETALLE(IDDETALLE,IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIOVENTA,SUBTOTAL) VALUES(5,3,1,15,120,1800);
INSERT INTO DETALLE(IDDETALLE,IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIOVENTA,SUBTOTAL) VALUES(6,3,3,1,45,45);
go

SET IDENTITY_INSERT DETALLE Off



-- actualizar tabla pedido

update pedido
set total = isnull( (select sum(subtotal) from detalle d where d.idpedido = p.idpedido), 0 )
from pedido p;
go


update pedido 
set importe = total / 1.18;
go

update pedido
set impuesto = total - importe;
go




